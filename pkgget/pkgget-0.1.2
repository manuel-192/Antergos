#!/bin/bash
#
# Install given precompiled AUR package(s) from a github repo.

# Output a random number.
_random() { shuf -i 1000-9999 -n 1 ; }

Usage()
{
    echo "Usage: $prog [--list] [package(s)]"
    echo "  -l | --list     Show available packages."
    echo "If only package(s) are given, then install them."
}

ListAvailable()
{
    local repo="$1"
    local info="/tmp/pkgs-$$.html"

    wget -q --timeout=10 -O $info $repo

    # packages:
    grep '\.sha512' $info | sed -e 's|^.*title="||' -e 's|\.sha512".*$||'
    rm -f $info
}

InstallPkg()
{
    local pkgname="$1"
    local repo="$2"
    local pkg="$(ListAvailable "$repo" | grep -P "^${pkgname}-[0-9][0-9\.\:]*-[0-9][0-9]*-[a-z][a-z0-9\_]*\.pkg\.tar[\.xgz]*$")"

    if [ "$pkg" = "" ] ; then
        echo "Error: no match for '$pkgname'!"
        return 1
    fi

    wget -q --timeout=20 "$repo/$pkg" "$repo/$pkg".sha512

    if [ $? -eq 0 ] ; then
        sha512sum -c "$pkg".sha512 >/dev/null
        if [ $? -eq 0 ] ; then
            sudo /usr/bin/pacman -U "$pkg"
        fi
    fi
}

Main()
{
    local repo=https://github.com/manuel-192/Antergos/raw/master/Antergos-packages
    local arg
    local pkgs pkg

    for arg in "$@"
    do
        case "$arg" in
            --list|-l) ListAvailable $repo ; return ;;
            -*) echo "Unknown option '$arg'" ; Usage ; return 1 ;;
            *) pkgs+="$arg " ;;
        esac
    done
    if [ "$pkgs" != "" ] ; then
        local workdir=/tmp/pkgget-$$-$(_random).dir
        mkdir -p $workdir
        cd $workdir

        for pkg in $pkgs
        do
            InstallPkg "$pkg" "$repo"
        done

        cd $OLDPWD
        rm -rf $workdir
    else
        echo "Nothing to do!"
    fi
}

Main "$@"
