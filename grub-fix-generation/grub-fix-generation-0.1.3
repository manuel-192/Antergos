#!/bin/bash
#
# A workaround for os-prober's initrd line generation problem on Antergos.
# This modifies two files, see their names in function _StartHere() below.
#
# NOTE: to restore old behavior, reinstall packages 'grub' and 'os-prober'.
#
# $Id: grub-fix-generation,v 1.3 2019/02/02 15:14:04 manuel Exp $

_check()
{
    "$@"
    if [ $? -ne 0 ] ; then
        echo "Error: '$*' failed."
        exit 1
    fi
}

_file1mod()
{
    sed "s|\(echo \${LINUX} \| cut -d ':' -f 5\)\`|\1 \| tr '^' ' '\`|"
}

_file2mod()
{
    sed -e 's|initrd="\$(echo "\$2"|shift; initrd="\$(echo "\$\@"|' \
        -e 's|initrd="/boot\$initrd"|initrd=($initrd); initrd=\${initrd[@]/#//boot}|'
}

_file()
{
    local mod="$1"
    local file="$2"
    local filebak="$file"-$(date +%Y%m%d-%H%M) # backup file with execution date

    _check mv $file $filebak

    cat $filebak | $mod > $file

    _check chmod +x $file
    _check chmod -x $filebak
}

_StartHere()
{
    _file _file1mod /etc/grub.d/30_os-prober
    _file _file2mod /usr/lib/linux-boot-probes/mounted/40grub2
}

_StartHere "$@"
